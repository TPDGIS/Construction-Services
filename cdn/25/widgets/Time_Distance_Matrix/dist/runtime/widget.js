System.register(["jimu-core","jimu-arcgis","jimu-ui","esri/layers/FeatureLayer","esri/layers/GraphicsLayer","esri/Graphic","esri/geometry/Point","esri/geometry/Polyline","esri/geometry/geometryEngine"],(function(e,t){var o={},i={},n={},r={},a={},s={},l={},d={},u={};return{setters:[function(e){o.React=e.React,o.jsx=e.jsx},function(e){i.JimuMapViewComponent=e.JimuMapViewComponent},function(e){n.Button=e.Button,n.Tab=e.Tab,n.Tabs=e.Tabs,n.TextInput=e.TextInput},function(e){r.default=e.default},function(e){a.default=e.default},function(e){s.default=e.default},function(e){l.default=e.default},function(e){d.default=e.default},function(e){u.union=e.union}],execute:function(){e((()=>{var e={89:e=>{"use strict";e.exports=s},196:e=>{"use strict";e.exports=d},244:e=>{"use strict";e.exports=o},321:e=>{"use strict";e.exports=n},422:e=>{"use strict";e.exports=l},620:e=>{"use strict";e.exports=a},633:e=>{"use strict";e.exports=r},686:e=>{"use strict";e.exports=i},958:e=>{"use strict";e.exports=u}},t={};function c(o){var i=t[o];if(void 0!==i)return i.exports;var n=t[o]={exports:{}};return e[o](n,n.exports,c),n.exports}c.d=(e,t)=>{for(var o in t)c.o(t,o)&&!c.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},c.p="";var p={};return c.p=window.jimuConfig.baseUrl,(()=>{"use strict";c.r(p),c.d(p,{__set_webpack_public_path__:()=>v,default:()=>y});var e=c(244),t=c(686),o=c(321),i=c(633),n=c(620),r=c(89),a=c(422),s=c(196),l=c(958),d=function(e,t,o,i){return new(o||(o=Promise))((function(n,r){function a(e){try{l(i.next(e))}catch(e){r(e)}}function s(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,s)}l((i=i.apply(e,t||[])).next())}))};const u="eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImZhMjIxNDQyMGNlNTQyOWM4MDg5MDkwZDA1ZWJkMzVkIiwiaCI6Im11cm11cjY0In0=",m="https://api.openrouteservice.org/v2/matrix/driving-car",f="https://api.openrouteservice.org/v2/directions/driving-car/geojson",g="https://services9.arcgis.com/izXUvkghw2ajVOfV/arcgis/rest/services/ConstructionServicesDepartmentEmployeeHomeLocation_ExportFeatures/FeatureServer/0",h=[{name:"MCO",latitude:40.28327148,longitude:-74.70641692},{name:"CJO",latitude:40.2454678,longitude:-74.2978332},{name:"NJO",latitude:40.6528661,longitude:-74.5718786},{name:"LIO",latitude:40.783398,longitude:-73.4168212},{name:"LVO",latitude:40.6127671,longitude:-75.3468996},{name:"BCO",latitude:40.288478,longitude:-75.155006},{name:"HBO",latitude:40.3119666,longitude:-76.8289298},{name:"PTO",latitude:40.2445347,longitude:-75.59112173},{name:"WCO",latitude:39.9858016,longitude:-75.59056},{name:"CPO",latitude:39.9541638,longitude:-75.1674432}];function y(c){var p,y;const[v,x]=e.React.useState(null),[j,w]=e.React.useState(null),[b,N]=e.React.useState(null),[T,C]=e.React.useState(""),[S,M]=e.React.useState("Waiting for map..."),[k,O]=e.React.useState([]),[R,E]=e.React.useState(null),[I,D]=e.React.useState([]),[F,$]=e.React.useState(null),[B,P]=e.React.useState(!1),[G,J]=e.React.useState("5"),z=e.React.useRef(null),[W,A]=e.React.useState("matrix"),[_,V]=e.React.useState([]),[q,L]=e.React.useState(""),[Z,H]=e.React.useState(""),[U,Q]=e.React.useState(""),[Y,X]=e.React.useState(""),[K,ee]=e.React.useState(null),[te,oe]=e.React.useState(""),ie=["#32CD32","#00BFFF","#FFD700","#FF8C00","#DC143C"];e.React.useEffect((()=>{const e=null==v?void 0:v.view;if(e){if(!j){const t=new n.default({title:"Routes"});e.map.add(t),w(t)}if(!b){const t=new i.default({url:g});e.map.add(t),N(t)}M("Map ready.")}}),[v,j,b]),e.React.useEffect((()=>{if(!b||"directions"!==W)return;let e=!1;return b.queryFeatures({where:"1=1",outFields:["Name","OBJECTID"],returnGeometry:!0}).then((t=>{if(e)return;const o=[...t.features||[]].sort(((e,t)=>{var o,i,n,r;return String(null!==(i=null===(o=e.attributes)||void 0===o?void 0:o.Name)&&void 0!==i?i:"").localeCompare(String(null!==(r=null===(n=t.attributes)||void 0===n?void 0:n.Name)&&void 0!==r?r:""))}));V(o)})).catch((()=>{e||V([])})),()=>{e=!0}}),[b,W]);const ne=()=>d(this,void 0,void 0,(function*(){const e=T.split("\n").map((e=>e.trim())).filter(Boolean),t=[];for(const o of e){const e=o.split(",").map((e=>parseFloat(e.trim())));if(2!==e.length||isNaN(e[0])||isNaN(e[1]))try{const e=encodeURIComponent(o),i=`https://api.openrouteservice.org/geocode/search?api_key=${u}&text=${e}`,n=yield fetch(i);if(!n.ok)throw new Error(`Geocode HTTP error: ${n.status}`);const r=yield n.json();if(r.features&&r.features.length>0){const[e,o]=r.features[0].geometry.coordinates;t.push(new a.default({longitude:e,latitude:o}))}else console.warn("No geocode results for:",o)}catch(e){console.warn("Geocoding failed for line:",o,e)}else t.push(new a.default({longitude:e[0],latitude:e[1]}))}return t})),re=e=>{const t=Math.floor(e/60),o=Math.round(e%60);return t>0?`${t} hr ${o} min`:`${o} min`},ae=(e,t)=>d(this,void 0,void 0,(function*(){var o,i,n;if(j&&v&&t.origin&&t.dest){M("Fetching route\u2026");try{const a=yield fetch(f,{method:"POST",headers:{Authorization:u,"Content-Type":"application/json"},body:JSON.stringify({coordinates:[[t.origin.longitude,t.origin.latitude],[t.dest.longitude,t.dest.latitude]]})});if(!a.ok)throw new Error("Directions request failed");const l=null===(n=null===(i=null===(o=(yield a.json()).features)||void 0===o?void 0:o[0])||void 0===i?void 0:i.geometry)||void 0===n?void 0:n.coordinates;if(!l)throw new Error("No geometry in response");const d=new s.default({paths:l}),c=t.color||"#DC143C",p=new r.default({geometry:d,symbol:{type:"simple-line",color:c,width:4}}),m=new r.default({geometry:t.dest,symbol:{type:"simple-marker",color:"red",size:10}});O((t=>{const o=[...t];return o[e]=Object.assign(Object.assign({},o[e]),{graphic:p,destGraphic:m}),o})),j.add(p),j.add(m),j.graphics.forEach((e=>e.visible=e===p||e===m)),b&&(b.definitionExpression=`Name = '${t.Name.replace(/'/g,"''")}'`,b.refresh());const g=v.view,h=p.geometry;if(null==h?void 0:h.extent){const e=h.extent.expand(1.8),t=Math.min(.25,-300/g.width),o=e.width*t;e.xmin+=o,e.xmax+=o,yield g.goTo({target:e,duration:1e3,padding:250})}M("Route drawn.")}catch(e){console.error(e),M("Failed to fetch route.")}finally{z.current=null}}}));return(0,e.jsx)("div",{className:"p-3 space-y-2",style:{height:"100%",overflow:"auto",minHeight:0}},(0,e.jsx)(o.Tabs,{value:W,onChange:A},(0,e.jsx)(o.Tab,{id:"matrix",title:"matrix"===W?(0,e.jsx)("span",{style:{fontWeight:700}},"Time Matrix"):(0,e.jsx)("span",{style:{fontWeight:400,color:"#888"}},"Time Matrix")},(0,e.jsx)("h4",null,"Time Matrix & Fastest Routes"),(0,e.jsx)("p",null,S),(0,e.jsx)(o.TextInput,{placeholder:"Enter destination (address or lon,lat)",value:T,onChange:e=>{C(e.target.value),oe("")}}),(0,e.jsx)("label",{className:"d-block mt-2"},"Or choose from offices"),(0,e.jsx)("select",{value:te,onChange:e=>{const t=e.target.value;if(oe(t),t){const e=h.find((e=>e.name===t));e&&C(`${e.longitude},${e.latitude}`)}else C("")},style:{width:"100%",padding:"6px",marginBottom:8,fontSize:14}},(0,e.jsx)("option",{value:""},"-- Select office --"),h.map((t=>(0,e.jsx)("option",{key:t.name,value:t.name},t.name)))),(0,e.jsx)("label",{className:"d-block mt-2"},"Number of routes"),(0,e.jsx)(o.TextInput,{type:"number",min:1,max:100,placeholder:"5",value:G,onChange:e=>J(e.target.value)}),(0,e.jsx)("div",{className:"d-flex justify-content-between mt-2"},(0,e.jsx)(o.Button,{type:"primary",onClick:()=>d(this,void 0,void 0,(function*(){if(!v||!b||!j)return void M("Map not ready yet.");const e=yield ne();if(!e.length)return void M("Please enter at least one destination.");M("Querying origins...");const t=(yield b.queryFeatures({where:"1=1",outFields:["*"],returnGeometry:!0})).features||[],o=e[0],i=parseInt(G,10),n=isNaN(i)||i<1?5:Math.min(i,100);i!==n&&M(`Using ${n} routes (invalid or out-of-range input).`);const a=t.map((e=>{if("point"!==e.geometry.type)return null;const t=e.geometry;return{feature:e,distance:Math.hypot(t.longitude-o.longitude,t.latitude-o.latitude)}})).filter(Boolean).sort(((e,t)=>e.distance-t.distance)).slice(0,n);if(D(a),!a.length)return void M("No valid origin points found.");M("Generating routes..."),j.removeAll(),O([]);e.map((e=>new r.default({geometry:e,symbol:{type:"simple-marker",color:"red",size:10}}))).forEach((e=>j.add(e)));const c=a.map((e=>e.feature.geometry));c.forEach((e=>j.add(new r.default({geometry:e,symbol:{type:"simple-marker",color:"blue",size:10}}))));const p={locations:[...c,...e].map((e=>[e.longitude,e.latitude])),sources:c.map(((e,t)=>t)),destinations:e.map(((e,t)=>c.length+t)),metrics:["duration","distance"],units:"m"};let g=!1;const h=[];try{const t=yield fetch(m,{method:"POST",headers:{Authorization:u,"Content-Type":"application/json"},body:JSON.stringify(p)});if(!t.ok)throw new Error(`Matrix HTTP error: ${t.status}`);const o=yield t.json(),i=[];for(let t=0;t<c.length;t++){const n=o.durations[t],r=o.distances[t];if(!n||!r)continue;let s=0,l=n[0];n.forEach(((e,t)=>{e<l&&(l=e,s=t)}));const d=c[t],u=e[s];i.push({i:t,minIndex:s,origin:d,dest:u,distanceMiles:r[s]/1609.34,durationMin:l/60,name:`${a[t].feature.attributes.Name}`})}const n=25,y=20;for(const e of i)h.push({Name:e.name,distanceMiles:e.distanceMiles,durationText:re(e.durationMin),color:"",graphic:null,destGraphic:null,origin:e.origin,dest:e.dest});g=h.length>0,h.length>0&&M("Matrix ready. Fetching route lines for first 20\u2026");const x=i.slice(0,y);for(let e=0;e<x.length;e+=n){const t=x.slice(e,e+n),o=yield Promise.all(t.map(((t,o)=>d(this,void 0,void 0,(function*(){var i,n,r;const a=yield fetch(f,{method:"POST",headers:{Authorization:u,"Content-Type":"application/json"},body:JSON.stringify({coordinates:[[t.origin.longitude,t.origin.latitude],[t.dest.longitude,t.dest.latitude]]})});if(!a.ok)return null;const s=null===(r=null===(n=null===(i=(yield a.json()).features)||void 0===i?void 0:i[0])||void 0===n?void 0:n.geometry)||void 0===r?void 0:r.coordinates;if(!s)return null;return{req:t,coords:s,idx:e+o}})))));for(const e of o){if(!e)continue;const{req:t,coords:o,idx:i}=e;if(i<0||i>=h.length)continue;const n=new s.default({paths:o}),a=new r.default({geometry:n,symbol:{type:"simple-line",color:"#000",width:4}}),l=new r.default({geometry:t.dest,symbol:{type:"simple-marker",color:"red",size:10}});h[i].graphic=a,h[i].destGraphic=l}}if(!g)return void M("\u274c Failed to generate routes.");h.sort(((e,t)=>{const o=e=>{const t=e.split(" ");return t.includes("hr")?60*parseInt(t[0])+parseInt(t[2]):parseInt(t[0])};return o(e.durationText)-o(t.durationText)})),h.forEach(((e,t)=>e.color=t<5?ie[t]:"#DC143C"));for(let e=h.length-1;e>=0;e--){const t=h[e];t.graphic&&(t.graphic.symbol={type:"simple-line",color:t.color,width:4},j.add(t.graphic),j.add(t.destGraphic))}O(h);const w=j.graphics.toArray();if(w.length>0){const e=w.map((e=>e.geometry)),t=l.union(e);if(null==t?void 0:t.extent){const e=v.view,o=t.extent.expand(1.8);$(o),yield e.goTo({target:o,duration:1e3,padding:250});const i=Math.min(.25,-300/e.width),n=o.width*i;o.xmin+=n,o.xmax+=n,yield e.goTo({target:o,duration:800})}}const N=a.map((e=>`'${e.feature.attributes.Name}'`));b.definitionExpression=`Name IN (${N.join(",")})`;const T=h.filter((e=>null!=e.graphic)).length;M(`\u2705 Routes generated. Table shows all ${h.length} routes; ${T} drawn on map.`)}catch(e){console.error(e),g||M("\u274c Failed to generate routes.")}})),className:"w-100 mr-2"},"Generate Time Matrix"),(0,e.jsx)(o.Button,{type:"primary",style:{backgroundColor:"#ffce2f"},className:"w-100",onClick:()=>window.location.reload()},"Reset")),(0,e.jsx)(t.JimuMapViewComponent,{useMapWidgetId:null===(p=c.config.useMapWidgetIds)||void 0===p?void 0:p[0],onActiveViewChange:x}),k.length>0&&(0,e.jsx)("table",{className:"w-full mt-3 border border-gray-700 text-black text-sm"},(0,e.jsx)("thead",null,(0,e.jsx)("tr",{className:"bg-gray-800 text-black"},(0,e.jsx)("th",{className:"px-3 py-2 text-left"},"Employee"),(0,e.jsx)("th",{className:"px-3 py-2 text-left"},"Distance (Miles)"),(0,e.jsx)("th",{className:"px-3 py-2 text-left"},"Drive Duration"))),(0,e.jsx)("tbody",null,k.map(((t,o)=>{const i=o===R,n=i?t.color:`${t.color}40`;return(0,e.jsx)("tr",{key:o,onClick:()=>(e=>{if(!j||!b||!v)return;const t=v.view,o=k[e];if(!o)return;if(R===e){E(null),j.graphics.forEach((e=>e.visible=!0));const e=I.map((e=>`'${e.feature.attributes.Name}'`));return b.definitionExpression=`Name IN (${e.join(",")})`,void(F&&t.goTo({target:F,duration:1e3,padding:250}))}if(E(e),!o.graphic||!o.destGraphic){if(o.origin&&o.dest){if(z.current===e)return;return z.current=e,void ae(e,o)}const i=I.find((e=>{var t;return(null===(t=e.feature.attributes)||void 0===t?void 0:t.Name)===o.Name}));return void((null==i?void 0:i.feature.geometry)&&t.goTo({target:i.feature.geometry,duration:1e3,padding:250}))}j.graphics.forEach((e=>e.visible=e===o.graphic||e===o.destGraphic));const i=k.filter((e=>e.graphic&&e.graphic.visible)).map((e=>`'${e.Name.replace(/'/g,"''")}'`));b.definitionExpression=i.length?`Name IN (${i.join(",")})`:"1=0",b.refresh();const n=o.graphic.geometry.extent.expand(1.8),r=Math.min(.25,-300/t.width),a=n.width*r;n.xmin+=a,n.xmax+=a,t.goTo({target:n,duration:1e3,padding:250})})(o),style:{backgroundColor:n,opacity:i?1:.6,border:i?"2px solid white":"1px solid #444"}},(0,e.jsx)("td",{className:"px-3 py-2"},t.Name),(0,e.jsx)("td",{className:"px-3 py-2"},t.distanceMiles.toFixed(2)),(0,e.jsx)("td",{className:"px-3 py-2"},t.durationText))}))))),(0,e.jsx)(o.Tab,{id:"directions",title:"directions"===W?(0,e.jsx)("span",{style:{fontWeight:700}},"Directions"):(0,e.jsx)("span",{style:{fontWeight:400,color:"#888"}},"Directions")},(0,e.jsx)("h4",null,"Directions"),(0,e.jsx)("p",null,Y),K&&(0,e.jsx)("p",{style:{marginTop:4,fontWeight:600}},"Distance: ",K.distanceMiles.toFixed(2)," mi \xb7 Duration: ",K.durationText),(0,e.jsx)("label",{className:"d-block mt-2"},"Starting Point"),(0,e.jsx)("select",{value:q,onChange:e=>L(e.target.value),style:{width:"100%",padding:"6px",marginBottom:8,fontSize:14}},(0,e.jsx)("option",{value:""},"-- Select --"),_.map((t=>{var o,i,n,r;return(0,e.jsx)("option",{key:null===(o=t.attributes)||void 0===o?void 0:o.OBJECTID,value:String(null===(i=t.attributes)||void 0===i?void 0:i.OBJECTID)},String(null!==(r=null===(n=t.attributes)||void 0===n?void 0:n.Name)&&void 0!==r?r:""))}))),(0,e.jsx)("label",{className:"d-block mt-2"},"Destination"),(0,e.jsx)("select",{value:Z,onChange:e=>H(e.target.value),style:{width:"100%",padding:"6px",marginBottom:8,fontSize:14}},(0,e.jsx)("option",{value:""},"-- Select office --"),h.map((t=>(0,e.jsx)("option",{key:t.name,value:t.name},t.name))),(0,e.jsx)("option",{value:"Custom address"},"Custom address")),("Custom address"===Z||!Z)&&(0,e.jsx)("div",null,(0,e.jsx)("label",{className:"d-block mt-2"},"Or type address"),(0,e.jsx)(o.TextInput,{placeholder:"Enter address",value:U,onChange:e=>Q(e.target.value),style:{width:"100%",marginBottom:8}})),(0,e.jsx)(o.Button,{type:"primary",className:"w-100 mt-2",onClick:()=>d(this,void 0,void 0,(function*(){var e,t,o,i,n,l,d,c,p;if(!j||!v)return void X("Map not ready.");const m=_.find((e=>{var t;return String(null===(t=e.attributes)||void 0===t?void 0:t.OBJECTID)===q}));if(!(null==m?void 0:m.geometry)||"point"!==m.geometry.type)return void X("Select a starting point.");const g=m.geometry;let y;if("Custom address"===Z||!Z){if(!(null==U?void 0:U.trim()))return void X("Select a destination or type an address.");X("Geocoding...");try{const t=`https://api.openrouteservice.org/geocode/search?api_key=${u}&text=${encodeURIComponent(U.trim())}`,o=yield fetch(t);if(!o.ok)throw new Error("Geocode failed");const i=yield o.json();if(!(null===(e=i.features)||void 0===e?void 0:e.length))return void X("Address not found.");const[n,r]=i.features[0].geometry.coordinates;y=new a.default({longitude:n,latitude:r})}catch(e){return void X("Address not found.")}}else{const e=h.find((e=>e.name===Z));if(!e)return void X("Select a destination.");y=new a.default({longitude:e.longitude,latitude:e.latitude})}X("Creating route...");try{const e=yield fetch(f,{method:"POST",headers:{Authorization:u,"Content-Type":"application/json"},body:JSON.stringify({coordinates:[[g.longitude,g.latitude],[y.longitude,y.latitude]]})});if(!e.ok)throw new Error("Directions request failed");const a=yield e.json(),m=null===(i=null===(o=null===(t=a.features)||void 0===t?void 0:t[0])||void 0===o?void 0:o.geometry)||void 0===i?void 0:i.coordinates;if(!m)throw new Error("No geometry in response");const h=null===(d=null===(l=null===(n=a.features)||void 0===n?void 0:n[0])||void 0===l?void 0:l.properties)||void 0===d?void 0:d.summary,x=null!==(c=null==h?void 0:h.distance)&&void 0!==c?c:0,w=null!==(p=null==h?void 0:h.duration)&&void 0!==p?p:0,b=x/1609.34,N=re(w/60);ee({distanceMiles:b,durationText:N});const T=new s.default({paths:m}),C=new r.default({geometry:T,symbol:{type:"simple-line",color:"#2563EB",width:4}}),S=new r.default({geometry:y,symbol:{type:"simple-marker",color:"red",size:10}});j.add(C),j.add(S);const M=v.view,k=C.geometry;if(null==k?void 0:k.extent){const e=k.extent.expand(1.2);yield M.goTo({target:e,duration:1e3,padding:250})}X("Route created.")}catch(e){console.error(e),X("Failed to create route."),ee(null)}}))},"Create Route"),(0,e.jsx)(t.JimuMapViewComponent,{useMapWidgetId:null===(y=c.config.useMapWidgetIds)||void 0===y?void 0:y[0],onActiveViewChange:x}))))}function v(e){c.p=e}})(),p})())}}}));